<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agenda Luxury 2026 - Keyboard Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Dancing+Script:wght@400;600&family=Playfair+Display:ital,wght@0,400;0,700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --desk: #0a0a0a; --leather: #1c130d; --gold: #b89352;
            --paper: #fcfaf2; --ink: #1a1a1a;
            --line-color: rgba(0, 0, 0, 0.12);
            --margin-color: rgba(220, 20, 60, 0.3);
        }
        .theme-dark {
            --paper: #1a1a1a; --ink: #e0d0b0;
            --line-color: rgba(184, 147, 82, 0.15);
            --margin-color: rgba(184, 147, 82, 0.4);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; background: var(--desk);
            font-family: 'Cormorant Garamond', serif;
            height: 100vh; display: flex; overflow: hidden;
            justify-content: center; align-items: center;
        }

        /* UI CONTROLS */
        .side-controls { position: fixed; display: flex; gap: 8px; z-index: 9999; }
        @media (min-width: 769px) {
            .side-controls { flex-direction: column; top: 50%; transform: translateY(-50%); }
            .controls-left { left: 15px; } .controls-right { right: 15px; }
        }
        @media (max-width: 768px) {
            .side-controls { flex-direction: row; top: 10px; left: 50%; transform: translateX(-50%); width: 95%; justify-content: center; flex-wrap: wrap; }
            .controls-right { top: 55px; }
            .btn-round { width: 38px !important; height: 38px !important; font-size: 1rem !important; }
            .select-luxury { width: 60px !important; font-size: 0.5rem !important; height: 30px !important; }
        }

        .btn-round {
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(20, 20, 20, 0.9); border: 1px solid var(--gold);
            color: var(--gold); cursor: pointer; display: flex;
            align-items: center; justify-content: center; transition: 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); backdrop-filter: blur(8px);
        }
        .btn-round.active { background: var(--gold); color: white; }
        .select-luxury {
            width: 80px; height: 35px; border-radius: 15px;
            background: rgba(20, 20, 20, 0.9); border: 1px solid var(--gold);
            color: var(--gold); cursor: pointer; font-size: 0.65rem; text-transform: uppercase;
        }

        /* BOOK */
        #book { width: 85vw; height: 85vh; position: relative; background: var(--leather); border-radius: 15px; box-shadow: 0 40px 80px rgba(0,0,0,0.8); }
        .page { position: absolute; background: var(--paper); color: var(--ink); padding: 25px 35px; display: flex; flex-direction: column; z-index: 10; overflow: hidden; }
        
        @media (min-width: 769px) {
            .page { width: calc(50% - 15px); height: calc(100% - 20px); top: 10px; }
            .page.left { left: 10px; border-radius: 10px 0 0 10px; }
            .page.right { right: 10px; border-radius: 0 10px 10px 0; border-left: 1px solid rgba(0,0,0,0.05); }
        }
        @media (max-width: 768px) {
            #book { width: 98vw; height: 55vh; margin-top: 110px; top: -50px; }
            .page { width: calc(100% - 10px); height: calc(100% - 10px); top: 5px; left: 5px; border-radius: 10px; padding: 15px; }
            .page.left { display: none; }
        }

        .editor {
            height: 100%; background-image: linear-gradient(transparent 31px, var(--line-color) 32px);
            background-size: 100% 32px; line-height: 32px; outline: none;
            padding-left: 15px; border-left: 2px solid var(--margin-color);
            font-size: 1.3rem; white-space: pre-wrap; position: relative; z-index: 1;
        }
        .draw-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
        body.pen-active .draw-layer { pointer-events: auto; }

        .page-header { border-bottom: 2px solid var(--gold); display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 5px; margin-bottom: 10px;}
        .header-day-num { font-family: 'Playfair Display'; font-size: 3.5rem; color: var(--gold); font-weight: 700; line-height: 0.8; }

        /* FULL VIRTUAL KEYBOARD */
        #virtual-keyboard {
            position: fixed; bottom: -100%; left: 0; width: 100%; 
            background: #111; padding: 10px 5px; z-index: 10001; 
            transition: bottom 0.3s ease; display: flex; flex-direction: column; 
            gap: 5px; border-top: 3px solid var(--gold);
            user-select: none;
        }
        .kb-row { display: flex; justify-content: center; gap: 4px; width: 100%; }
        .kb-key {
            background: #2a2a2a; color: white; border: 1px solid #444; 
            border-radius: 5px; height: 45px; flex: 1;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-family: 'Inter'; font-size: 1rem; font-weight: 600;
        }
        .kb-key:active { background: var(--gold); color: black; }
        .key-special { background: #3d3d3d; flex: 1.5; font-size: 0.8rem; }
        .key-space { flex: 4; }
        .key-gold { background: var(--gold); color: black; border: none; }
        .key-active { background: var(--gold); color: black; }

        #calendar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .cal-grid-container { display: grid; gap: 15px; width: 100%; max-width: 1000px; max-height: 80vh; overflow-y: auto; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); background: #111; padding: 20px; border: 1px solid var(--gold); }
        .cal-month button { background: none; border: 1px solid #333; color: white; margin: 2px; width: 30px; height: 30px; cursor: pointer; }
    </style>
</head>
<body class="theme-light">

    <div class="side-controls controls-left">
        <button class="btn-round" onclick="toggleFullScreen()">â›¶</button>
        <button class="btn-round" onclick="goDirectlyToToday()">ðŸŽ¯</button>
        <button class="btn-round" onclick="toggleTheme()">â—‘</button>
        <button class="btn-round" onclick="toggleCalendar()">ðŸ“…</button>
        <button class="btn-round" onclick="exportData()">ðŸ’¾</button>
        <button class="btn-round" onclick="document.getElementById('importFile').click()">ðŸ“‚</button>
        <input type="file" id="importFile" hidden onchange="importData(event)">
    </div>

    <div class="side-controls controls-right">
        <button class="btn-round" id="pen-toggle" onclick="togglePen()">âœŽ</button>
        <button class="btn-round" id="eraser-toggle" onclick="toggleEraser()">ðŸ§¹</button>
        <div class="btn-round" style="overflow:hidden;"><input type="color" id="inkColor" onchange="updatePenSettings()" style="transform:scale(2); cursor:pointer;"></div>
        <select id="penSize" class="select-luxury" onchange="updatePenSettings()">
            <option value="2">Fine</option>
            <option value="5" selected>Med</option>
            <option value="12">Big</option>
        </select>
        <button class="btn-round" onclick="clearDraw()">âŒ«</button>
        <select id="fontPicker" class="select-luxury" onchange="changeFont(this.value)">
            <option value="'Dancing Script'">Corsivo</option>
            <option value="'Inter'">Moderno</option>
            <option value="'Playfair Display'">Classico</option>
        </select>
    </div>

    <main id="book">
        <div style="position:absolute; width:100%; height:100%; display:flex; z-index:5;">
            <div style="flex:1;" onclick="turnPage('prev')"></div>
            <div style="flex:1;" onclick="turnPage('next')"></div>
        </div>
        <div class="page left" id="p-left-static"></div>
        <div class="page right" id="p-right-static"></div>
    </main>

    <div id="virtual-keyboard">
        <div id="kb-container"></div>
    </div>

    <div id="calendar-overlay" onclick="toggleCalendar()">
        <div class="cal-grid-container" id="cal-box" onclick="event.stopPropagation()"></div>
    </div>

<script>
    let state = { d: 1, dark: false, font: "'Dancing Script'", content: {}, draws: {}, penColor: "#1a1a1a", penWidth: "5" };
    let isPenActive = false, isEraserActive = false, focusedEditor = null;
    let kbMode = 'lower'; // 'lower', 'upper', 'symbols'

    const keys = {
        lower: [
            ['q','w','e','r','t','y','u','i','o','p'],
            ['a','s','d','f','g','h','j','k','l'],
            ['SHIFT','z','x','c','v','b','n','m','BKSP'],
            ['123','SPACE','ENTER','â–²','â–¼','â—€','â–¶','CHIUDI']
        ],
        upper: [
            ['Q','W','E','R','T','Y','U','I','O','P'],
            ['A','S','D','F','G','H','J','K','L'],
            ['shift','Z','X','C','V','B','N','M','BKSP'],
            ['123','SPACE','ENTER','â–²','â–¼','â—€','â–¶','CHIUDI']
        ],
        symbols: [
            ['1','2','3','4','5','6','7','8','9','0'],
            ['@','#','â‚¬','&','*','-','+','(',')','/'],
            ['ABC','.',',','?','!',"'",'"',':',';','BKSP'],
            ['123','SPACE','ENTER','â–²','â–¼','â—€','â–¶','CHIUDI']
        ]
    };

    window.onload = () => {
        const saved = localStorage.getItem('agenda_luxury_v26_responsive');
        if (saved) state = JSON.parse(saved); else goDirectlyToToday();
        applyTheme(); renderStatic(); buildCalendar(); renderKeyboard();
    };

    function renderKeyboard() {
        const container = document.getElementById('kb-container');
        container.innerHTML = '';
        keys[kbMode].forEach(row => {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'kb-row';
            row.forEach(key => {
                const btn = document.createElement('div');
                btn.className = 'kb-key';
                if(['SHIFT','shift','BKSP','123','ABC','ENTER','CHIUDI'].includes(key)) btn.classList.add('key-special');
                if(key === 'SPACE') btn.classList.add('key-space');
                if(key === 'CHIUDI') btn.classList.add('key-gold');
                if((kbMode === 'upper' && key === 'shift') || (kbMode === 'symbols' && key === '123')) btn.classList.add('key-active');
                
                btn.innerText = key;
                btn.onclick = (e) => { e.preventDefault(); handleKeyPress(key); };
                rowDiv.appendChild(btn);
            });
            container.appendChild(rowDiv);
        });
    }

    function handleKeyPress(key) {
        if(!focusedEditor) return;
        focusedEditor.focus();

        switch(key) {
            case 'CHIUDI': closeKb(); break;
            case 'SHIFT': kbMode = 'upper'; renderKeyboard(); break;
            case 'shift': kbMode = 'lower'; renderKeyboard(); break;
            case '123': kbMode = 'symbols'; renderKeyboard(); break;
            case 'ABC': kbMode = 'lower'; renderKeyboard(); break;
            case 'BKSP': document.execCommand('delete', false); break;
            case 'ENTER': document.execCommand('insertLineBreak', false); break;
            case 'SPACE': document.execCommand('insertText', false, ' '); break;
            case 'â–²': moveCursor('up'); break;
            case 'â–¼': moveCursor('down'); break;
            case 'â—€': moveCursor('left'); break;
            case 'â–¶': moveCursor('right'); break;
            default:
                document.execCommand('insertText', false, key);
                if(kbMode === 'upper') { kbMode = 'lower'; renderKeyboard(); }
        }
        state.content[focusedEditor.id.split('-')[1]] = focusedEditor.innerHTML;
        saveToLocal();
    }

    function moveCursor(dir) {
        const sel = window.getSelection();
        if(dir === 'left') sel.modify("move", "backward", "character");
        if(dir === 'right') sel.modify("move", "forward", "character");
        if(dir === 'up') sel.modify("move", "backward", "line");
        if(dir === 'down') sel.modify("move", "forward", "line");
    }

    function getPageHTML(day) {
        if (day < 1 || day > 365) return `<div style="display:flex; height:100%; align-items:center; justify-content:center; opacity:0.2"><h3>FINE 2026</h3></div>`;
        const date = new Date(2026, 0, day);
        return `
            <div class="page-header">
                <div>
                    <h3 style="margin:0; color:var(--gold); text-transform:uppercase; font-size:0.7rem;">${date.toLocaleDateString('it-IT', {month:'long'})} 2026</h3>
                    <h2 style="margin:0; font-family:'Playfair Display'; font-size:1.2rem; font-style:italic;">${date.toLocaleDateString('it-IT', {weekday:'long'})}</h2>
                </div>
                <div class="header-day-num">${date.getDate()}</div>
            </div>
            <div style="position:relative; flex:1;">
                <div class="editor" contenteditable="true" id="edit-${day}" 
                     onfocus="focusedEditor=this; openKb();"
                     oninput="state.content[${day}] = this.innerHTML; saveToLocal();"
                     style="font-family: ${state.font}">${state.content[day] || ""}</div>
                <canvas id="canv-${day}" class="draw-layer"></canvas>
            </div>`;
    }

    function renderStatic() {
        const isMobile = window.innerWidth <= 768;
        document.getElementById('p-right-static').innerHTML = getPageHTML(isMobile ? state.d : state.d + 1);
        if(!isMobile) document.getElementById('p-left-static').innerHTML = getPageHTML(state.d);
        setTimeout(() => { initCanvas(state.d); if(!isMobile) initCanvas(state.d + 1); }, 100);
    }

    function openKb() { if(window.innerWidth <= 768) document.getElementById('virtual-keyboard').style.bottom = '0'; }
    function closeKb() { document.getElementById('virtual-keyboard').style.bottom = '-100%'; if(focusedEditor) focusedEditor.blur(); }

    function initCanvas(day) {
        const canvas = document.getElementById(`canv-${day}`);
        if(!canvas) return;
        const ctx = canvas.getContext('2d'), container = canvas.parentElement;
        canvas.width = container.offsetWidth; canvas.height = container.offsetHeight;
        if(state.draws[day]) { const img = new Image(); img.onload = () => ctx.drawImage(img, 0, 0); img.src = state.draws[day]; }

        let drawing = false;
        const getCoords = (e) => {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        };

        canvas.onmousedown = canvas.ontouchstart = (e) => { 
            if(!isPenActive && !isEraserActive) return;
            drawing = true; ctx.beginPath(); const p = getCoords(e); ctx.moveTo(p.x, p.y); 
        };
        canvas.onmousemove = canvas.ontouchmove = (e) => {
            if(!drawing) return; const p = getCoords(e);
            if(isEraserActive) ctx.clearRect(p.x-12, p.y-12, 24, 24);
            else { ctx.lineWidth = state.penWidth; ctx.lineCap = 'round'; ctx.strokeStyle = state.penColor; ctx.lineTo(p.x, p.y); ctx.stroke(); }
        };
        canvas.onmouseup = canvas.ontouchend = () => { if(drawing) { drawing = false; state.draws[day] = canvas.toDataURL(); saveToLocal(); } };
    }

    function turnPage(dir) {
        if(isPenActive || isEraserActive) return;
        const step = window.innerWidth <= 768 ? 1 : 2;
        if (dir === 'next' && state.d + step <= 365) state.d += step;
        else if (dir === 'prev' && state.d - step >= 1) state.d -= step;
        renderStatic(); saveToLocal();
    }

    function togglePen() { isPenActive = !isPenActive; isEraserActive = false; updateUI(); }
    function toggleEraser() { isEraserActive = !isEraserActive; isPenActive = false; updateUI(); }
    function updateUI() {
        document.body.classList.toggle('pen-active', isPenActive || isEraserActive);
        document.getElementById('pen-toggle').classList.toggle('active', isPenActive);
        document.getElementById('eraser-toggle').classList.toggle('active', isEraserActive);
    }
    function clearDraw() {
        const id = focusedEditor ? focusedEditor.id.split('-')[1] : state.d;
        const c = document.getElementById(`canv-${id}`);
        if(c) { c.getContext('2d').clearRect(0,0,c.width,c.height); delete state.draws[id]; saveToLocal(); }
    }
    function saveToLocal() { localStorage.setItem('agenda_luxury_v26_responsive', JSON.stringify(state)); }
    function applyTheme() { document.body.className = state.dark ? 'theme-dark' : 'theme-light'; }
    function toggleTheme() { state.dark = !state.dark; applyTheme(); saveToLocal(); }
    function changeFont(f) { state.font = f; renderStatic(); saveToLocal(); }
    function updatePenSettings() { state.penColor = document.getElementById('inkColor').value; state.penWidth = document.getElementById('penSize').value; }
    function toggleCalendar() { const c = document.getElementById('calendar-overlay'); c.style.display = (c.style.display==='flex')?'none':'flex'; }
    function goDirectlyToToday() { const n = new Date(); const start = new Date(2026, 0, 0); state.d = Math.floor((new Date(2026, n.getMonth(), n.getDate()) - start) / 86400000); renderStatic(); }
    function buildCalendar() {
        const box = document.getElementById('cal-box');
        const months = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
        months.forEach((m, mi) => {
            const mDiv = document.createElement('div');
            mDiv.innerHTML = `<h4 style="color:var(--gold); margin:5px 0;">${m}</h4>`;
            let days = new Date(2026, mi+1, 0).getDate();
            for(let d=1; d<=days; d++) {
                const btn = document.createElement('button'); btn.innerText = d;
                btn.onclick = () => { state.d = Math.floor((new Date(2026, mi, d) - new Date(2026,0,0)) / 86400000); renderStatic(); toggleCalendar(); };
                mDiv.appendChild(btn);
            }
            box.appendChild(mDiv);
        });
    }
    function exportData() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(state)], {type:'application/json'})); a.download = `agenda_2026.json`; a.click(); }
    function importData(e) { const r = new FileReader(); r.onload = (ev) => { state = JSON.parse(ev.target.result); renderStatic(); applyTheme(); }; r.readAsText(e.target.files[0]); }
    function toggleFullScreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
</script>
</body>
</html>
