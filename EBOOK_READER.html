<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>3D Reader Pro - Navigation Edition</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>

    <style>
        :root { --accent: #e67e22; --bg: #1a1a1a; --panel: #222; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; color: white; overflow: hidden; }
        
        /* Header & Toolbar */
        .toolbar { background: var(--panel); padding: 12px; display: flex; gap: 15px; align-items: center; border-bottom: 2px solid var(--accent); }
        .btn { background: var(--accent); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        /* Main Viewport */
        .viewport { flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px; }
        #book-wrapper { width: 500px; height: 700px; }
        #book-container { width: 100%; height: 100%; }
        
        .page { width: 100%; height: 100%; background: white; overflow: hidden; display: none; }
        .page-content { padding: 40px; color: #222; font-family: serif; font-size: 18px; line-height: 1.6; }

        /* Footer Navigation */
        .nav-bar { background: var(--panel); padding: 10px 20px; display: flex; align-items: center; gap: 20px; border-top: 1px solid #444; }
        .slider-container { flex-grow: 1; display: flex; align-items: center; gap: 10px; }
        input[type="range"] { flex-grow: 1; cursor: pointer; accent-color: var(--accent); }
        
        .page-info { font-family: monospace; font-size: 14px; white-space: nowrap; }
        .jump-container { display: flex; align-items: center; gap: 5px; }
        .jump-input { width: 50px; padding: 5px; border-radius: 4px; border: 1px solid #444; background: #333; color: white; text-align: center; }
    </style>
</head>
<body>

<div class="toolbar">
    <label class="btn">ðŸ“‚ CARICA <input type="file" id="file-input" hidden accept=".pdf,.epub,.docx,.txt"></label>
    <select id="voice-select" class="btn" style="background:#444"></select>
    <button class="btn" onclick="toggleTTS()">ðŸ”Š Leggi</button>
    <div id="status" style="flex-grow:1; font-size:12px">Pronto.</div>
</div>

<div class="viewport">
    <div id="book-wrapper">
        <div id="book-container"></div>
    </div>
</div>

<div class="nav-bar">
    <div class="page-info">Pagina: <span id="current-page">0</span> / <span id="total-pages">0</span></div>
    
    <div class="slider-container">
        <input type="range" id="page-slider" min="0" max="0" value="0">
    </div>

    <div class="jump-container">
        Vai a: <input type="number" id="page-jump" class="jump-input" min="1">
        <button class="btn" style="padding: 5px 10px;" onclick="jumpToPage()">Vai</button>
    </div>
</div>

<script>
    let pageFlip = null;
    let currentPagesContent = [];
    const synth = window.speechSynthesis;
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    // Elementi UI
    const slider = document.getElementById('page-slider');
    const jumpInput = document.getElementById('page-jump');
    const currentPageLabel = document.getElementById('current-page');
    const totalPagesLabel = document.getElementById('total-pages');

    // Inizializza voci TTS
    synth.onvoiceschanged = () => {
        const voices = synth.getVoices().filter(v => v.lang.startsWith('it'));
        document.getElementById('voice-select').innerHTML = voices.map(v => `<option value="${v.name}">${v.name}</option>`).join('');
    };

    document.getElementById('file-input').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const container = document.getElementById('book-container');
        container.innerHTML = '';
        currentPagesContent = [];
        if (pageFlip) pageFlip.destroy();

        const ext = file.name.split('.').pop().toLowerCase();
        try {
            if (ext === 'pdf') await processPDF(file);
            else if (ext === 'epub') await processEPUB(file);
            else if (ext === 'docx') await processDOCX(file);
            else await processTXT(file);

            document.querySelectorAll('.page').forEach(p => p.style.display = 'block');
            initFlipEngine();
        } catch (err) { alert("Errore: " + err.message); }
    });

    // --- LOGICA DI NAVIGAZIONE ---
    
    function updateUI(pageIndex) {
        const displayNum = pageIndex + 1;
        currentPageLabel.innerText = displayNum;
        slider.value = pageIndex;
        jumpInput.value = displayNum;
    }

    slider.oninput = () => {
        if (pageFlip) pageFlip.turnToPage(parseInt(slider.value));
    };

    function jumpToPage() {
        const val = parseInt(jumpInput.value) - 1;
        if (pageFlip && val >= 0 && val < pageFlip.getPageCount()) {
            pageFlip.turnToPage(val);
        }
    }

    function initFlipEngine() {
        const container = document.getElementById('book-container');
        pageFlip = new St.PageFlip(container, {
            width: 500, height: 700,
            showCover: false, usePortrait: true
        });
        
        pageFlip.loadFromHTML(document.querySelectorAll('.page'));
        
        // Setup UI post-caricamento
        const total = pageFlip.getPageCount();
        totalPagesLabel.innerText = total;
        slider.max = total - 1;
        updateUI(0);

        // Evento cambio pagina: aggiorna slider e input
        pageFlip.on('flip', (e) => {
            updateUI(e.data);
        });
    }

    // --- PARSING (Versioni Ottimizzate) ---

    async function processPDF(file) {
        const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const vp = page.getViewport({ scale: 1.2 });
            const pageDiv = document.createElement('div');
            pageDiv.className = 'page';
            const canvas = document.createElement('canvas');
            canvas.width = vp.width; canvas.height = vp.height;
            await page.render({ canvasContext: canvas.getContext('2d'), viewport: vp }).promise;
            pageDiv.appendChild(canvas);
            const text = await page.getTextContent();
            currentPagesContent.push(text.items.map(s => s.str).join(' '));
            document.getElementById('book-container').appendChild(pageDiv);
        }
    }

    async function processEPUB(file) {
        const book = ePub(await file.arrayBuffer());
        await book.opened;
        const spine = await book.loaded.spine;
        for (const section of spine.spineItems) {
            await section.load(book.load.bind(book));
            const pageDiv = document.createElement('div');
            pageDiv.className = 'page';
            const inner = document.createElement('div');
            inner.className = 'page-content';
            inner.innerHTML = await section.render();
            pageDiv.appendChild(inner);
            currentPagesContent.push(inner.innerText);
            document.getElementById('book-container').appendChild(pageDiv);
            section.unload();
        }
    }

    async function processDOCX(file) {
        const res = await mammoth.convertToHtml({arrayBuffer: await file.arrayBuffer()});
        const chunks = res.value.split(/<h[1-3]>|<p>/g).filter(s => s.length > 5);
        chunks.forEach(c => {
            const pageDiv = document.createElement('div');
            pageDiv.className = 'page';
            pageDiv.innerHTML = `<div class="page-content">${c}</div>`;
            currentPagesContent.push(pageDiv.innerText);
            document.getElementById('book-container').appendChild(pageDiv);
        });
    }

    async function processTXT(file) {
        const text = await file.text();
        const chunks = text.match(/.{1,1000}/gs) || [];
        chunks.forEach(c => {
            const pageDiv = document.createElement('div');
            pageDiv.className = 'page';
            pageDiv.innerHTML = `<div class="page-content">${c}</div>`;
            currentPagesContent.push(c);
            document.getElementById('book-container').appendChild(pageDiv);
        });
    }

    // Rotella Mouse
    window.addEventListener('wheel', (e) => {
        if (!pageFlip) return;
        if (e.deltaY > 0) pageFlip.flipNext();
        else pageFlip.flipPrev();
    }, { passive: true });

    function toggleTTS() {
        if (!pageFlip) return;
        synth.cancel();
        const msg = new SpeechSynthesisUtterance(currentPagesContent[pageFlip.getCurrentPageIndex()]);
        msg.voice = synth.getVoices().find(v => v.name === document.getElementById('voice-select').value);
        msg.lang = 'it-IT';
        synth.speak(msg);
    }
</script>
</body>
</html>