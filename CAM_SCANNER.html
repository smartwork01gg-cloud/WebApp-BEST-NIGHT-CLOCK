<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Documenti - Rettificazione Prospettica</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
    
/* Applica questo a Canvas e punti per bloccare ogni movimento della pagina */
#sourceCanvas {
    /* Disabilita TUTTI i gesti del browser (scroll, zoom, menu contestuale) */
    touch-action: none !important; 
    user-select: none !important;
    -webkit-user-select: none;
    /* Evita che il tocco venga intercettato da elementi sovrapposti */
    pointer-events: auto !important;
}

.point {
    /* Rende i punti "trasparenti" ai Pointer Events cos√¨ il canvas legge sempre il tocco */
    pointer-events: none !important; 
}
  
#zoomHelper {
    position: fixed; /* FONDAMENTALE: resta agganciato allo schermo, non alla pagina */
    z-index: 10000;  /* Sopra a tutto */
    pointer-events: none; /* Il tocco deve passare "attraverso" lo zoom */
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    display: none;
}    
    /* Impedisce al browser di gestire il tocco (niente scroll o zoom nativo) */
#sourceContainer, #sourceCanvas {
    touch-action: none !important;
    -webkit-user-select: none;
    user-select: none;
    overscroll-behavior: contain;
}

/* Assicurati che il contenitore non tagli gli elementi */
.workspace {
    overflow: visible !important;
    position: relative;
}
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0e17;
            min-height: 100vh;
            overflow-x: hidden;
            color: #e2e8f0;
        }

        .container {
            max-width: 100%;
            min-height: 100vh;
            background: linear-gradient(180deg, #0f1419 0%, #1a1f2e 100%);
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%);
            color: white;
            padding: 16px;
            text-align: center;
            flex-shrink: 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.05) 50%, transparent 70%);
            pointer-events: none;
        }

        h1 {
            font-size: 1.25em;
            margin-bottom: 4px;
            position: relative;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .subtitle {
            opacity: 0.9;
            font-size: 0.75em;
            position: relative;
        }

        .controls {
            padding: 12px;
            background: #1a1f2e;
            border-bottom: 1px solid #2d3748;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .btn {
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            white-space: nowrap;
            flex: 1 1 auto;
            min-width: 140px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .btn-primary:active {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: scale(0.98);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-success:active {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: scale(0.98);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
        }

        .btn-secondary:active {
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
            transform: scale(0.98);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        input[type="file"] {
            display: none;
        }

        .filter-controls {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #0f1419;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #2d3748;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-weight: 600;
            font-size: 13px;
            color: #cbd5e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .filter-group select {
            width: 100%;
            padding: 8px 12px;
            background: #0a0e17;
            border: 1px solid #3b82f6;
            border-radius: 6px;
            color: #cbd5e0;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            outline: none;
            transition: all 0.2s;
        }

        .filter-group select:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .filter-group select option {
            background: #1a1f2e;
            color: #cbd5e0;
            padding: 8px;
        }

        .filter-group input[type="range"] {
            width: 100%;
            height: 6px;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, #2d3748 0%, #4a5568 100%);
            border-radius: 5px;
            outline: none;
        }

        .filter-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.5);
            transition: transform 0.2s;
        }

        .filter-group input[type="range"]::-webkit-slider-thumb:active {
            transform: scale(1.2);
        }

        .filter-group input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.5);
        }

        .filter-group .value {
            font-size: 13px;
            color: #3b82f6;
            font-weight: 700;
            min-width: 50px;
            text-align: right;
        }

        .workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .canvas-container {
            position: relative;
            background: #0a0e17;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            min-height: 40vh;
        }

        .canvas-container h3 {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(26, 31, 46, 0.95);
            backdrop-filter: blur(10px);
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            color: #cbd5e0;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            border: 1px solid #2d3748;
        }

        canvas {
            display: block;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 4px;
        }

        .placeholder {
            color: #64748b;
            text-align: center;
            padding: 40px 20px;
            font-size: 15px;
        }

        .point {
            position: absolute;
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: 4px solid #0f172a;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: move;
            box-shadow: 0 0 0 2px #3b82f6, 0 4px 16px rgba(59, 130, 246, 0.6);
            z-index: 1000;
            touch-action: none;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .point:active {
            transform: translate(-50%, -50%) scale(1.15);
            box-shadow: 0 0 0 2px #2563eb, 0 6px 20px rgba(37, 99, 235, 0.8);
        }

        .point-label {
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            white-space: nowrap;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            transition: background 0.15s;
        }

        .zoom-helper {
            position: absolute;
            width: 150px;
            height: 150px;
            border: 3px solid #3b82f6;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.8), 0 0 0 2px #0f172a;
            pointer-events: none;
            z-index: 2000;
            background: #0a0e17;
            overflow: hidden;
            display: none;
        }

        .zoom-helper canvas {
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
        }

        .zoom-helper::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            border: 2px solid #3b82f6;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.8);
        }

        .zoom-helper::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #3b82f6;
            z-index: 9;
        }

        .zoom-helper .crosshair-v {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 1px;
            background: #3b82f6;
            z-index: 9;
        }

        .instructions {
            background: #1a1f2e;
            padding: 12px 16px;
            border-top: 2px solid #3b82f6;
            flex-shrink: 0;
        }

        .instructions h4 {
            color: #cbd5e0;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 700;
        }

        .instructions ul {
            list-style: none;
            padding-left: 0;
        }

        .instructions li {
            padding: 3px 0;
            color: #94a3b8;
            font-size: 12px;
            line-height: 1.4;
        }

        .instructions li:before {
            content: "‚úì ";
            color: #10b981;
            font-weight: bold;
            margin-right: 6px;
        }

        .status {
            position: fixed;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #3b82f6;
            color: #cbd5e0;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 13px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10000;
            max-width: calc(100% - 32px);
            text-align: center;
            box-shadow: 0 8px 24px rgba(0,0,0,0.6);
        }

        .status.show {
            opacity: 1;
        }

        .view-toggle {
            display: flex;
            gap: 4px;
            background: #0f1419;
            padding: 4px;
            border-radius: 8px;
            width: 100%;
            border: 1px solid #2d3748;
        }

        .view-toggle button {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-toggle button.active {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: #e0e7ff;
            box-shadow: 0 2px 8px rgba(30, 58, 138, 0.4);
        }

        .canvas-wrapper {
            display: none;
            width: 100%;
            height: 100%;
        }

        .canvas-wrapper.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Desktop */
/* --- AGGIUNTA PER MOBILE --- */
@media (max-width: 1023px) {
    .controls {
        padding: 8px;
        gap: 6px;
    }
    .btn {
        padding: 10px 4px;
        font-size: 11px; /* Font leggermente pi√π piccolo per far stare tutto */
        min-width: 0;
        flex: 1 1 30%; /* Forza 3 bottoni per riga */
    }
    .point {
        width: 44px; /* Area di tocco pi√π grande */
        height: 44px;
    }
    .filter-group {
        padding: 8px;
    }
}
        
        @media (min-width: 1024px) {
            body {
                padding: 20px;
            }

            .container {
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.8);
                max-width: 1400px;
                margin: 0 auto;
                border: 1px solid #2d3748;
            }

            h1 {
                font-size: 2em;
            }

            .subtitle {
                font-size: 0.95em;
            }

            .header {
                padding: 30px;
                border-radius: 20px 20px 0 0;
            }

            .controls {
                padding: 20px;
                gap: 12px;
            }

            .btn {
                min-width: auto;
                flex: 0 0 auto;
            }

            .filter-controls {
                width: auto;
                flex-direction: row;
                gap: 15px;
                padding: 0;
                background: transparent;
                border: none;
            }

            .filter-group {
                min-width: 200px;
                background: #0f1419;
                padding: 12px 16px;
                border-radius: 8px;
                border: 1px solid #2d3748;
            }

            .workspace {
                flex-direction: row;
                min-height: 600px;
            }

            .canvas-container {
                flex: 1;
                min-height: 500px;
            }

            .canvas-wrapper {
                display: flex !important;
            }

            .view-toggle {
                display: none;
            }

            .point {
                width: 20px;
                height: 20px;
            }

            .point:hover {
                transform: translate(-50%, -50%) scale(1.2);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÑ Scanner Documenti Avanzato</h1>
            <p class="subtitle">Rettificazione prospettica e ottimizzazione immagini</p>
        </div>

        <div class="controls">
            <label class="btn btn-primary">
                üìÅ Carica File
                <input type="file" id="fileInput" accept="image/*">
            </label>
            
            <button class="btn btn-primary" id="cameraBtn">
                üì∑ Fotocamera
            </button>

            <button class="btn btn-success" id="rectifyBtn" disabled>
                ‚ú® Rettifica
            </button>

            <button class="btn btn-secondary" id="resetBtn">
                üîÑ Reset
            </button>

            <button class="btn btn-success" id="saveJpgBtn" disabled>
                üíæ JPG
            </button>

            <button class="btn btn-success" id="savePdfBtn" disabled>
                üìë PDF
            </button>

            <div class="filter-controls">
                <div class="filter-group">
                    <label>
                        Modalit√† Colore
                    </label>
                    <select id="colorModeSelect">
                        <option value="color">Colore</option>
                        <option value="grayscale">Scala di Grigi</option>
                        <option value="bw">Bianco e Nero</option>
                    </select>
                </div>

                <div class="filter-group" id="bwThresholdGroup" style="display: none;">
                    <label>
                        Soglia B/N
                        <span class="value" id="thresholdValue">128</span>
                    </label>
                    <input type="range" id="thresholdSlider" min="0" max="255" value="128">
                </div>

                <div class="filter-group">
                    <label>
                        Contrasto
                        <span class="value" id="contrastValue">100%</span>
                    </label>
                    <input type="range" id="contrastSlider" min="50" max="200" value="100">
                </div>

                <div class="filter-group">
                    <label>
                        Luminosit√†
                        <span class="value" id="brightnessValue">100%</span>
                    </label>
                    <input type="range" id="brightnessSlider" min="50" max="150" value="100">
                </div>

                <div class="filter-group">
                    <label>
                        Nitidezza
                        <span class="value" id="sharpnessValue">0</span>
                    </label>
                    <input type="range" id="sharpnessSlider" min="0" max="100" value="0">
                </div>
            </div>
        </div>

        <div class="instructions">
            <h4>üìã Istruzioni:</h4>
            <ul>
                <li>Carica immagine o scatta foto</li>
                <li>Trascina i 4 punti sugli angoli del documento</li>
                <li>Premi "Rettifica" per correggere la prospettiva</li>
                <li>Regola filtri e salva JPG/PDF</li>
            </ul>
        </div>

        <div class="view-toggle">
            <button class="active" data-view="source">üì∑ Originale</button>
            <button data-view="result">‚ú® Risultato</button>
        </div>

        <div class="workspace">
            <div class="canvas-wrapper active" id="sourceWrapper">
                <div class="canvas-container" id="sourceContainer">
                    <h3>Immagine Originale</h3>
                    <canvas id="sourceCanvas"></canvas>
                    <div class="placeholder" id="sourcePlaceholder">
                        Carica un'immagine o usa la fotocamera
                    </div>
                    <div class="zoom-helper" id="zoomHelper">
                        <canvas id="zoomCanvas"></canvas>
                        <div class="crosshair-v"></div>
                    </div>
                </div>
            </div>

            <div class="canvas-wrapper" id="resultWrapper">
                <div class="canvas-container" id="resultContainer">
                    <h3>Risultato Rettificato</h3>
                    <canvas id="resultCanvas"></canvas>
                    <div class="placeholder" id="resultPlaceholder">
                        Il risultato apparir√† qui dopo la rettificazione
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="status" id="status"></div>

<script>
    // 1. ELEMENTI DOM E VARIABILI
    const fileInput = document.getElementById('fileInput');
    const cameraBtn = document.getElementById('cameraBtn');
    const sourceCanvas = document.getElementById('sourceCanvas');
    const resultCanvas = document.getElementById('resultCanvas');
    const sourceCtx = sourceCanvas.getContext('2d');
    const resultCtx = resultCanvas.getContext('2d');
    const sourceContainer = document.getElementById('sourceContainer');
    const rectifyBtn = document.getElementById('rectifyBtn');
    const resetBtn = document.getElementById('resetBtn');
    const saveJpgBtn = document.getElementById('saveJpgBtn');
    const savePdfBtn = document.getElementById('savePdfBtn');
    const contrastSlider = document.getElementById('contrastSlider');
    const brightnessSlider = document.getElementById('brightnessSlider');
    const sharpnessSlider = document.getElementById('sharpnessSlider');
    const colorModeSelect = document.getElementById('colorModeSelect');
    const thresholdSlider = document.getElementById('thresholdSlider');
    const bwThresholdGroup = document.getElementById('bwThresholdGroup');
    const status = document.getElementById('status');

    let sourceImage = null;
    let points = [];
    let pointElements = [];
    let selectedPoint = null;
    let rectifiedImageData = null;

    const zoomHelper = document.getElementById('zoomHelper');
    const zoomCanvas = document.getElementById('zoomCanvas');
    const zoomCtx = zoomCanvas.getContext('2d');

    // 2. GESTIONE INPUT (FILE E FOTOCAMERA)
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => loadImage(event.target.result);
            reader.readAsDataURL(file);
        }
    });

    cameraBtn.addEventListener('click', async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment', width: { ideal: 4096 }, height: { ideal: 2160 } } 
            });
            const video = document.createElement('video');
            video.srcObject = stream;
            await video.play();
            const track = stream.getVideoTracks()[0];
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:10000;display:flex;flex-direction:column;';
            video.style.cssText = 'width:100%;flex-grow:1;object-fit:contain;';
            modal.appendChild(video);
            const controls = document.createElement('div');
            controls.style.cssText = 'padding:20px;display:flex;justify-content:space-around;background:#111;';
            const captureBtn = document.createElement('button');
            captureBtn.innerHTML = 'üì∏ SCATTA';
            captureBtn.className = 'btn btn-primary btn-lg';
            captureBtn.onclick = () => {
                const canvas = document.createElement('canvas');
                const settings = track.getSettings();
                canvas.width = settings.width;
                canvas.height = settings.height;
                canvas.getContext('2d').drawImage(video, 0, 0);
                stream.getTracks().forEach(t => t.stop());
                document.body.removeChild(modal);
                loadImage(canvas.toDataURL('image/jpeg', 1.0));
            };
            controls.appendChild(captureBtn);
            modal.appendChild(controls);
            document.body.appendChild(modal);
        } catch (err) { showStatus('Errore: ' + err.message); }
    });

    function loadImage(src) {
        const img = new Image();
        img.onload = () => {
            sourceImage = img;
            const maxWidth = window.innerWidth > 600 ? 600 : window.innerWidth - 40;
            let width = img.width;
            let height = img.height;
            const ratio = Math.min(maxWidth / width, 600 / height);
            width *= ratio; height *= ratio;
            
            sourceCanvas.width = width;
            sourceCanvas.height = height;
            sourceCtx.drawImage(img, 0, 0, width, height);
            document.getElementById('sourcePlaceholder').style.display = 'none';
            sourceCanvas.style.display = 'block';

            // Reset punti e auto-detection (se disponibile nel tuo CSS/HTML)
            const m = 40;
            points = [{x:m, y:m}, {x:width-m, y:m}, {x:width-m, y:height-m}, {x:m, y:height-m}];
            renderPoints();
            rectifyBtn.disabled = false;
            autoRectify();
        };
        img.src = src;
    }

    // 3. TRASCINAMENTO E ZOOM
    function getCanvasCoords(e) {
        const rect = sourceCanvas.getBoundingClientRect();
        return {
            x: (e.clientX - rect.left) * (sourceCanvas.width / rect.width),
            y: (e.clientY - rect.top) * (sourceCanvas.height / rect.height)
        };
    }

    sourceCanvas.addEventListener('pointerdown', (e) => {
        sourceCanvas.setPointerCapture(e.pointerId);
        const coords = getCanvasCoords(e);
        let minDist = 50; 
        selectedPoint = null;

        points.forEach((p, index) => {
            const dist = Math.hypot(p.x - coords.x, p.y - coords.y);
            if (dist < minDist) { minDist = dist; selectedPoint = index; }
        });
        if (selectedPoint !== null) renderPoints();
    });

    sourceCanvas.addEventListener('pointermove', (e) => {
        if (selectedPoint === null) return;
        const coords = getCanvasCoords(e);
        points[selectedPoint] = {
            x: Math.max(0, Math.min(sourceCanvas.width, coords.x)),
            y: Math.max(0, Math.min(sourceCanvas.height, coords.y))
        };
        renderPoints();
        updateZoomHelper(points[selectedPoint].x, points[selectedPoint].y, e.clientX, e.clientY);
    });

    sourceCanvas.addEventListener('pointerup', (e) => {
        if (selectedPoint !== null) {
            sourceCanvas.releasePointerCapture(e.pointerId);
            selectedPoint = null;
            zoomHelper.style.display = 'none';
            renderPoints();
            autoRectify();
        }
    });

    function updateZoomHelper(canvasX, canvasY, screenX, screenY) {
        zoomHelper.style.display = 'block';
        const zw = 160, zh = 160;
        let left = screenX - zw/2, top = screenY - zh - 60;
        if (left < 10) left = 10;
        if (top < 10) top = screenY + 60;
        
        zoomHelper.style.left = left + 'px';
        zoomHelper.style.top = top + 'px';

        const scaleX = sourceImage.width / sourceCanvas.width;
        const scaleY = sourceImage.height / sourceCanvas.height;
        zoomCanvas.width = zw; zoomCanvas.height = zh;
        zoomCtx.imageSmoothingEnabled = false;
        zoomCtx.drawImage(sourceImage, canvasX*scaleX-20, canvasY*scaleY-20, 40, 40, 0, 0, zw, zh);
        
        zoomCtx.strokeStyle = '#3b82f6'; zoomCtx.lineWidth = 2;
        zoomCtx.beginPath(); zoomCtx.moveTo(zw/2,0); zoomCtx.lineTo(zw/2,zh); zoomCtx.moveTo(0,zh/2); zoomCtx.lineTo(zw,zh/2); zoomCtx.stroke();
    }

    function renderPoints() {
        pointElements.forEach(el => el.remove());
        pointElements = [];
        sourceCtx.drawImage(sourceImage, 0, 0, sourceCanvas.width, sourceCanvas.height);
        sourceCtx.strokeStyle = '#3b82f6'; sourceCtx.lineWidth = 2;
        sourceCtx.beginPath();
        sourceCtx.moveTo(points[0].x, points[0].y);
        points.forEach(p => sourceCtx.lineTo(p.x, p.y));
        sourceCtx.closePath(); sourceCtx.stroke();

        points.forEach((p, i) => {
            const el = document.createElement('div');
            el.className = 'point';
            el.style.cssText = `left:${p.x}px;top:${p.y}px;position:absolute;pointer-events:none;`;
            if (selectedPoint === i) el.style.background = '#fbbf24';
            sourceContainer.appendChild(el);
            pointElements.push(el);
        });
    }

    // 4. MATEMATICA OMOGRAFICA
    function distance(p1, p2) { return Math.sqrt((p2.x-p1.x)**2 + (p2.y-p1.y)**2); }
    
    function orderPointsClockwise(pts) {
        const center = pts.reduce((acc, p) => ({x:acc.x+p.x/4, y:acc.y+p.y/4}), {x:0, y:0});
        return [...pts].sort((a,b) => Math.atan2(a.y-center.y, a.x-center.x) - Math.atan2(b.y-center.y, b.x-center.x));
    }

    function invertHomography(H) {
        const [[a,b,c],[d,e,f],[g,h,i]] = H;
        const det = a*(e*i-f*h)-b*(d*i-f*g)+c*(d*h-e*g);
        const invDet = 1/det;
        return [
            [(e*i-f*h)*invDet, (c*h-b*i)*invDet, (b*f-c*e)*invDet],
            [(f*g-d*i)*invDet, (a*i-c*g)*invDet, (c*d-a*f)*invDet],
            [(d*h-e*g)*invDet, (b*g-a*h)*invDet, (a*e-b*d)*invDet]
        ];
    }

    function computeHomography(src, dst) {
        const A = []; const b = [];
        for (let i = 0; i < 4; i++) {
            A.push([src[i].x, src[i].y, 1, 0, 0, 0, -dst[i].x*src[i].x, -dst[i].x*src[i].y]);
            b.push(dst[i].x);
            A.push([0, 0, 0, src[i].x, src[i].y, 1, -dst[i].y*src[i].x, -dst[i].y*src[i].y]);
            b.push(dst[i].y);
        }
        const n = b.length;
        for (let i=0; i<n; i++) {
            let max = i;
            for (let k=i+1; k<n; k++) if (Math.abs(A[k][i]) > Math.abs(A[max][i])) max = k;
            [A[i], A[max]] = [A[max], A[i]]; [b[i], b[max]] = [b[max], b[i]];
            for (let k=i+1; k<n; k++) {
                const f = A[k][i] / A[i][i];
                b[k] -= f * b[i];
                for (let j=i; j<n; j++) A[k][j] -= f * A[i][j];
            }
        }
        const x = new Array(n);
        for (let i=n-1; i>=0; i--) {
            x[i] = b[i];
            for (let j=i+1; j<n; j++) x[i] -= A[i][j] * x[j];
            x[i] /= A[i][i];
        }
        return [[x[0],x[1],x[2]], [x[3],x[4],x[5]], [x[6],x[7],1]];
    }

    // 5. FILTRI E NITIDEZZA
    function applySharpen(imageData, amount) {
        const w = imageData.width, h = imageData.height;
        const output = new ImageData(new Uint8ClampedArray(imageData.data), w, h);
        const k = [0, -amount, 0, -amount, 1 + 4 * amount, -amount, 0, -amount, 0];
        for (let y = 1; y < h - 1; y++) {
            for (let x = 1; x < w - 1; x++) {
                const i = (y * w + x) * 4;
                for (let c = 0; c < 3; c++) {
                    let sum = 0;
                    for (let ky = -1; ky <= 1; ky++) {
                        for (let kx = -1; kx <= 1; kx++) {
                            sum += imageData.data[((y + ky) * w + (x + kx)) * 4 + c] * k[(ky + 1) * 3 + (kx + 1)];
                        }
                    }
                    output.data[i + c] = sum;
                }
            }
        }
        return output;
    }

    function applyFilters() {
        if (!rectifiedImageData) return;
        const contrast = Math.pow(contrastSlider.value / 100, 2);
        const brightness = brightnessSlider.value / 100;
        const mode = colorModeSelect.value;
        const thr = parseInt(thresholdSlider.value);
        
        let img = new ImageData(new Uint8ClampedArray(rectifiedImageData.data), rectifiedImageData.width, rectifiedImageData.height);
        const d = img.data;

        for (let i = 0; i < d.length; i += 4) {
            let r = d[i], g = d[i+1], b = d[i+2];
            if (mode === 'grayscale' || mode === 'bw') {
                r = g = b = (r * 0.299 + g * 0.587 + b * 0.114);
            }
            r = ((r - 128) * contrast + 128) * brightness;
            g = ((g - 128) * contrast + 128) * brightness;
            b = ((b - 128) * contrast + 128) * brightness;
            
            if (mode === 'bw') {
                const v = (r + g + b) / 3 > thr ? 255 : 0;
                r = g = b = v;
            }
            d[i] = r; d[i+1] = g; d[i+2] = b;
        }

        if (sharpnessSlider.value > 0) img = applySharpen(img, sharpnessSlider.value / 100);
        resultCtx.putImageData(img, 0, 0);
    }

    // 6. RETTIFICA E ESPORTAZIONE
    function autoRectify() {
        if (!sourceImage || points.length < 4) return;
        const ratioX = sourceImage.width / sourceCanvas.width;
        const ratioY = sourceImage.height / sourceCanvas.height;
        const sorted = orderPointsClockwise(points);
        const realSrc = sorted.map(p => ({x: p.x*ratioX, y: p.y*ratioY}));
        const w = Math.max(distance(realSrc[0], realSrc[1]), distance(realSrc[3], realSrc[2]));
        const h = Math.max(distance(realSrc[0], realSrc[3]), distance(realSrc[1], realSrc[2]));

        resultCanvas.width = w; resultCanvas.height = h;
        const Hinv = invertHomography(computeHomography(realSrc, [{x:0,y:0},{x:w,y:0},{x:w,y:h},{x:0,y:h}]));

        const tCanvas = document.createElement('canvas');
        tCanvas.width = sourceImage.width; tCanvas.height = sourceImage.height;
        const tCtx = tCanvas.getContext('2d');
        tCtx.drawImage(sourceImage, 0, 0);
        const srcData = tCtx.getImageData(0,0,tCanvas.width,tCanvas.height);
        const dstData = resultCtx.createImageData(w, h);

        for (let y=0; y<h; y++) {
            for (let x=0; x<w; x++) {
                const den = Hinv[2][0]*x + Hinv[2][1]*y + Hinv[2][2];
                const sx = (Hinv[0][0]*x + Hinv[0][1]*y + Hinv[0][2]) / den;
                const sy = (Hinv[1][0]*x + Hinv[1][1]*y + Hinv[1][2]) / den;
                if (sx>=0 && sx<srcData.width-1 && sy>=0 && sy<srcData.height-1) {
                    const idx = (y*Math.floor(w)+x)*4;
                    const sidx = (Math.floor(sy)*srcData.width + Math.floor(sx))*4;
                    dstData.data[idx]=srcData.data[sidx];
                    dstData.data[idx+1]=srcData.data[sidx+1];
                    dstData.data[idx+2]=srcData.data[sidx+2];
                    dstData.data[idx+3]=255;
                }
            }
        }
        rectifiedImageData = dstData;
        applyFilters();
        document.getElementById('resultPlaceholder').style.display = 'none';
        resultCanvas.style.display = 'block';
        saveJpgBtn.disabled = savePdfBtn.disabled = false;
    }

    // 7. LISTENER PULSANTI E SLIDER
    resetBtn.addEventListener('click', () => {
        if (!sourceImage) return;
        const m = 40;
        points = [{x:m, y:m}, {x:sourceCanvas.width-m, y:m}, {x:sourceCanvas.width-m, y:sourceCanvas.height-m}, {x:m, y:sourceCanvas.height-m}];
        renderPoints(); autoRectify();
        showStatus('Vertici resettati');
    });

    [contrastSlider, brightnessSlider, sharpnessSlider, thresholdSlider].forEach(s => s.addEventListener('input', () => {
        const val = document.getElementById(s.id.replace('Slider', 'Value'));
        if (val) val.textContent = s.value + (s.id.includes('sharpness') ? '' : '%');
        applyFilters();
    }));

    colorModeSelect.addEventListener('change', () => {
        bwThresholdGroup.style.display = colorModeSelect.value === 'bw' ? 'flex' : 'none';
        applyFilters();
    });

    saveJpgBtn.addEventListener('click', () => {
        const link = document.createElement('a');
        link.download = `scan_${Date.now()}.jpg`;
        link.href = resultCanvas.toDataURL('image/jpeg', 0.95);
        link.click();
        showStatus('JPG salvato!');
    });

    savePdfBtn.addEventListener('click', () => {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
            orientation: resultCanvas.width > resultCanvas.height ? 'l' : 'p',
            unit: 'px',
            format: [resultCanvas.width, resultCanvas.height]
        });
        pdf.addImage(resultCanvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, resultCanvas.width, resultCanvas.height);
        pdf.save(`scan_${Date.now()}.pdf`);
        showStatus('PDF salvato!');
    });

    function showStatus(msg) { status.textContent = msg; status.classList.add('show'); setTimeout(()=>status.classList.remove('show'), 2000); }
</script>

</body>
</html>