<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BIOMETRIC ID - AI POWERED</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root { --amber: #ffb000; --cyan: #00f3ff; --bg: #0d1117; --panel: #161b22; }
        * { box-sizing: border-box; touch-action: none; -webkit-user-select: none; }
        body { background: var(--bg); color: #fff; font-family: system-ui, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* VISORE */
        .viewport { position: relative; width: 100%; height: 50vh; flex-shrink: 0; background: #000; display: flex; justify-content: center; border-bottom: 1px solid #30363d; }
        .frame { position: relative; width: 280px; height: 360px; background: #222; overflow: hidden; margin-top: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        video, #editor { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
        video { transform: scaleX(-1); z-index: 1; }
        #editor { z-index: 2; display: none; cursor: move; }
        
        /* Guide visive minimali (SOLO RIFERIMENTO) */
        .guides { position: absolute; inset: 0; z-index: 10; pointer-events: none; opacity: 0.7; }
        .guide-line { stroke: var(--cyan); stroke-width: 1; stroke-dasharray: 5,5; }
        .guide-zone { stroke: var(--amber); stroke-width: 2; fill: none; stroke-dasharray: 10,5; }

        /* Loader AI */
        #ai-loader { position: absolute; inset: 0; background: rgba(0,0,0,0.8); z-index: 20; display: none; justify-content: center; align-items: center; flex-direction: column; color: var(--cyan); }
        .spinner { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--cyan); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* CONTROLLI */
        .controls { flex-grow: 1; overflow-y: auto; padding: 20px; background: var(--panel); touch-action: pan-y; }
        .card { background: #0d1117; border: 1px solid #30363d; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        h3 { color: var(--cyan); font-size: 0.75rem; text-transform: uppercase; margin: 0 0 12px 0; }
        .btn-main { background: var(--amber); color: #000; border: none; width: 100%; padding: 15px; font-size: 1rem; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-tool { background: transparent; color: var(--cyan); border: 1px solid var(--cyan); padding: 10px; border-radius: 6px; flex: 1; font-size: 0.75rem; cursor: pointer; }
        .btn-tool.active { background: var(--cyan); color: #000; }
        .slider-row { margin-bottom: 12px; }
        input[type="range"] { width: 100%; accent-color: var(--cyan); }
        label { font-size: 0.7rem; color: #8b949e; display: block; margin-bottom: 4px; }

        /* MODALE EXPORT */
        #modal-export { display: none; position: fixed; inset: 0; background: #fff; z-index: 2000; padding: 20px; color: #000; overflow-y: auto; }
        .a4-print { width: 210mm; display: flex; flex-wrap: wrap; gap: 5mm; margin: 0 auto; background: white; padding: 10mm; border: 1px solid #eee;}
        @media print { .no-print { display: none; } #modal-export { position: absolute; display: block; } }
    </style>
</head>
<body>

<div class="viewport no-print">
    <div class="frame">
        <video id="webcam" autoplay playsinline></video>
        <canvas id="editor"></canvas>
        <svg class="guides" viewBox="0 0 280 360">
            <ellipse cx="140" cy="160" rx="70" ry="95" class="guide-zone" />
            <line x1="40" y1="150" x2="240" y2="150" class="guide-line" />
             <line x1="100" y1="255" x2="180" y2="255" class="guide-line" stroke="var(--amber)"/>
        </svg>
        <div id="ai-loader"><div class="spinner"></div><div>Elaborazione AI...</div></div>
    </div>
</div>

<div class="controls no-print">
    <div id="cap-grp">
        <button class="btn-main" id="snap-btn">SCATTA FOTO</button>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn-tool" onclick="document.getElementById('f-in').click()">IMPORTA FILE</button>
            <button class="btn-tool" id="flip-btn">GIRA CAMERA</button>
        </div>
        <input type="file" id="f-in" hidden accept="image/*">
    </div>

    <div id="edit-grp" style="display:none">
        <div class="card">
            <h3>AI & Ritocco</h3>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button class="btn-tool" id="ai-bg-btn" style="flex:2; border-color: var(--amber); color:var(--amber)">✨ RIMUOVI SFONDO CON AI</button>
                <button class="btn-tool" id="beauty-btn">BEAUTY</button>
            </div>
            <div class="slider-row">
                <label>Zoom & Sposta (Touch/Mouse)</label>
                <input type="range" id="zoom" min="0.1" max="3" step="0.01" value="1">
            </div>
            <div class="slider-row">
                <label>Luminosità</label>
                <input type="range" id="bright" min="50" max="150" value="100">
            </div>
        </div>

        <div class="card">
            <h3>Output</h3>
            <select id="fmt" style="width:100%; padding:10px; background:#0d1117; color:#fff; border:1px solid #30363d; border-radius:6px;">
                <option value="35,45">Passaporto / CIE (35x45mm)</option>
                <option value="30,40">Patente (30x40mm)</option>
                <option value="50,50">Visto USA (50x50mm)</option>
            </select>
        </div>

        <button class="btn-main" id="export-view-btn">GENERA STAMPA / PDF</button>
        <button class="btn-tool" onclick="location.reload()" style="width:100%; margin-top:10px; color:#ff5555; border-color:#ff5555;">ANNULLA</button>
    </div>
</div>

<div id="modal-export">
    <div class="no-print" style="margin-bottom:20px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <button class="btn-main" onclick="window.print()" style="grid-column: span 2;">STAMPA</button>
        <button class="btn-tool" id="dl-jpg" style="color:#000; border-color:#ccc">SCARICA JPG</button>
        <button class="btn-tool" id="dl-pdf" style="color:#000; border-color:#ccc">SCARICA PDF</button>
        <button class="btn-tool" onclick="document.getElementById('modal-export').style.display='none'" style="grid-column: span 2; color:#000; border-color:#ccc">INDIETRO</button>
    </div>
    <div class="a4-print" id="pg"></div>
</div>

<script>
    const vid = document.getElementById('webcam');
    const cvs = document.getElementById('editor');
    const ctx = cvs.getContext('2d');
    const loader = document.getElementById('ai-loader');
    
    let srcImg = new Image();
    // Canvas offscreen per processare l'immagine originale con l'AI
    let processCanvas = document.createElement('canvas'); 
    let processCtx = processCanvas.getContext('2d');
    let segmentedMask = null; // Conterrà la maschera generata dall'AI

    let px=0, py=0, sc=1.0, dragging=false, lx, ly, ld=0, beauty=false, useAI=false, side="user";

    // --- SETUP AI MEDIAPIPE ---
    const selfieSegmentation = new SelfieSegmentation({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`});
    selfieSegmentation.setOptions({ modelSelection: 1 }); // 1 = landscape model (più preciso ma più lento)
    selfieSegmentation.onResults(onAIResults);

    // --- FOTOCAMERA ---
    async function startCam() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: side, width: 1280, height: 720 } });
            vid.srcObject = stream;
        } catch(e) { alert("Errore Fotocamera"); }
    }
    startCam();
    document.getElementById('flip-btn').onclick = () => { side = (side==="user"?"environment":"user"); startCam(); };

    // --- EDITOR ---
    function loadEditor(src) {
        document.getElementById('cap-grp').style.display = 'none';
        document.getElementById('edit-grp').style.display = 'block';
        vid.style.display = 'none'; cvs.style.display = 'block';
        srcImg = new Image();
        srcImg.onload = () => {
            cvs.width = 700; cvs.height = 900; // Risoluzione di lavoro alta
            sc = Math.max(cvs.width/srcImg.width, cvs.height/srcImg.height);
            px = (cvs.width - srcImg.width * sc)/2;
            py = (cvs.height - srcImg.height * sc)/2;
            document.getElementById('zoom').value = sc;
            drawFinal();
        };
        srcImg.src = src;
    }

    document.getElementById('snap-btn').onclick = () => {
        const c = document.createElement('canvas'); c.width = vid.videoWidth; c.height = vid.videoHeight;
        const x = c.getContext('2d');
        if(side==="user") { x.translate(c.width, 0); x.scale(-1, 1); }
        x.drawImage(vid, 0, 0);
        loadEditor(c.toDataURL('image/jpeg'));
    };
    document.getElementById('f-in').onchange = (e) => {
        const r = new FileReader(); r.onload = (f) => loadEditor(f.target.result); r.readAsDataURL(e.target.files[0]);
    };

    // --- LOGICA AI ---
    document.getElementById('ai-bg-btn').onclick = async function() {
        if(useAI) { // Disattiva AI
             useAI = false; this.classList.remove('active'); segmentedMask = null; drawFinal(); return;
        }
        // Attiva AI
        this.classList.add('active');
        loader.style.display = 'flex';
        // Prepara l'immagine per l'AI (deve essere processata alla sua risoluzione nativa)
        processCanvas.width = srcImg.width; processCanvas.height = srcImg.height;
        processCtx.drawImage(srcImg, 0, 0);
        // Invia all'AI
        await selfieSegmentation.send({image: processCanvas});
    };

    function onAIResults(results) {
        // L'AI ci restituisce una maschera di segmentazione
        segmentedMask = results.segmentationMask;
        useAI = true;
        loader.style.display = 'none';
        drawFinal();
    }

    // --- RENDERING FINALE ---
    function drawFinal() {
        ctx.save();
        ctx.clearRect(0, 0, cvs.width, cvs.height);
        
        const b = document.getElementById('bright').value;
        
        // 1. Disegna Sfondo (se AI attiva)
        if(useAI && segmentedMask) {
            ctx.fillStyle = "#F2F4F7"; // Grigio ICAO neutro chiarissimo
            ctx.fillRect(0,0, cvs.width, cvs.height);
            
            // PREPARIAMO LA MASCHERA SUL CANVAS PRINCIPALE
            // Dobbiamo disegnare la maschera AI rispettando zoom e posizione attuali dell'utente
            ctx.save();
             // Applica le trasformazioni di zoom/pan dell'utente anche alla maschera
            ctx.translate(px, py);
            ctx.scale(sc, sc);
            
            // Usiamo la composizione per "ritagliare"
            ctx.globalCompositeOperation = "destination-out";
            // Disegniamo la maschera (che è nera dove c'è lo sfondo, trasparente dove c'è la persona)
            // È necessario invertire la logica di default di mediapipe per destination-out
            ctx.drawImage(segmentedMask, 0, 0, srcImg.width, srcImg.height);
            
            ctx.restore();
            // Ora il canvas ha un buco a forma di persona sullo sfondo grigio.
            // Il prossimo disegno andrà "sotto" questo buco.
            ctx.globalCompositeOperation = "destination-over";
        }

        // 2. Applica Filtri all'immagine sorgente
        let filterString = `brightness(${b}%) contrast(105%)`;
        if(beauty) filterString += ` saturate(115%) blur(1px)`;
        ctx.filter = filterString;

        // 3. Disegna l'immagine sorgente (persona)
        ctx.drawImage(srcImg, px, py, srcImg.width * sc, srcImg.height * sc);
        
        // Se beauty è attivo, aggiungi un secondo passaggio di "glow" per la pelle
        if(beauty) {
            ctx.globalAlpha = 0.4;
            ctx.filter = `brightness(${b}%) blur(3px)`;
            // Usiamo 'source-atop' per applicare il glow solo dove abbiamo appena disegnato la persona
            if(useAI) ctx.globalCompositeOperation = "source-atop";
            ctx.drawImage(cvs, 0, 0);
        }

        ctx.restore();
    }


    // --- INTERAZIONE (Drag & Zoom) ---
    const getP = (e) => ({ x: e.touches?e.touches[0].clientX:e.clientX, y: e.touches?e.touches[0].clientY:e.clientY });
    cvs.onmousedown = cvs.ontouchstart = (e) => {
        if(e.touches && e.touches.length===2) ld = Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
        else { dragging=true; const p=getP(e); lx=p.x; ly=p.y; }
    };
    window.onmousemove = window.ontouchmove = (e) => {
        if(e.touches && e.touches.length===2) { e.preventDefault(); const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY); sc*=(d/ld); ld=d; document.getElementById('zoom').value=sc; }
        else if(dragging) { const p=getP(e); px+=(p.x-lx)*(cvs.width/cvs.offsetWidth); py+=(p.y-ly)*(cvs.height/cvs.offsetHeight); lx=p.x; ly=p.y; }
        drawFinal();
    };
    window.onmouseup = window.ontouchend = () => { dragging=false; ld=0; };
    cvs.onwheel = (e) => { e.preventDefault(); sc*=(e.deltaY<0?1.1:0.9); document.getElementById('zoom').value=sc; drawFinal(); };

    // --- UI & EXPORT ---
    document.getElementById('beauty-btn').onclick = function() { beauty=!beauty; this.classList.toggle('active'); drawFinal(); };
    document.getElementById('zoom').oninput = (e) => { sc=e.target.value; drawFinal(); };
    document.getElementById('bright').oninput = drawFinal;

    document.getElementById('export-view-btn').onclick = () => {
        const g = document.getElementById('pg'); g.innerHTML = '';
        const d = cvs.toDataURL('image/jpeg', 0.98);
        const [w, h] = document.getElementById('fmt').value.split(',');
        for(let i=0; i<4; i++) { const m=new Image(); m.src=d; m.style.width=w+"mm"; m.style.height=h+"mm"; m.style.border="1px solid #eee"; g.appendChild(m); }
        document.getElementById('modal-export').style.display = 'block';
    };
    document.getElementById('dl-jpg').onclick = () => { const a=document.createElement('a'); a.download='foto_biometrica.jpg'; a.href=cvs.toDataURL('image/jpeg', 1.0); a.click(); };
    document.getElementById('dl-pdf').onclick = () => {
        const pdf = new jspdf.jsPDF(); const d = cvs.toDataURL('image/jpeg', 1.0); const [w, h] = document.getElementById('fmt').value.split(',').map(Number);
        pdf.addImage(d,'JPEG',10,10,w,h); pdf.addImage(d,'JPEG',10+w+5,10,w,h); pdf.addImage(d,'JPEG',10,10+h+5,w,h); pdf.addImage(d,'JPEG',10+w+5,10+h+5,w,h);
        pdf.save("documento.pdf");
    };
</script>
</body>
</html>