<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ICAO Biometric ID - Professional Edition</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@300;500;700&display=swap');
        
        :root { 
            --amber: #ffb000; 
            --cyan: #00f3ff; 
            --bg: #010409; 
            --panel: #0d1117;
            --surface: #161b22;
            --border: rgba(255, 255, 255, 0.1);
            --cyan-glow: rgba(0, 243, 255, 0.3);
            --amber-glow: rgba(255, 176, 0, 0.3);
        }
        
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
        }
        
        body, html { 
            width: 100%; 
            height: 100%; 
            background: var(--bg); 
            color: #e6edf3; 
            font-family: 'Outfit', sans-serif;
            overflow: hidden; 
        }

        /* HEADER */
        .app-header {
            background: linear-gradient(180deg, var(--panel) 0%, transparent 100%);
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(20px);
            position: relative;
            z-index: 100;
        }
        
        .app-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: var(--cyan);
            text-shadow: 0 0 20px var(--cyan-glow);
        }
        
        .app-subtitle {
            font-size: 0.7rem;
            color: #7d8590;
            margin-top: 0.25rem;
            font-family: 'JetBrains Mono', monospace;
        }

        /* 1. VIEWPORT FOTO (FISSA) */
        .viewport {
            height: 40vh;
            width: 100%;
            display: flex; 
            justify-content: center; 
            align-items: center;
            background: #000; 
            border-bottom: 2px solid var(--cyan);
            box-shadow: 0 4px 30px var(--cyan-glow);
            position: relative; 
            z-index: 10;
        }

        .canvas-frame {
            position: relative; 
            width: 280px; 
            height: 360px; 
            background: radial-gradient(circle at center, rgba(0, 243, 255, 0.05) 0%, transparent 70%);
            overflow: hidden;
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
        }

        video, #editor-cvs { 
            position: absolute; 
            inset: 0; 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        
        video { 
            transform: scaleX(-1); 
            z-index: 1;
        }
        
        #editor-cvs { 
            display: none; 
            z-index: 5; 
            touch-action: none;
            cursor: move;
        }

        /* Guide Biometriche ICAO - Proporzioni Corrette */
        .icao-mask { 
            position: absolute; 
            inset: 0; 
            z-index: 20; 
            pointer-events: none;
            opacity: 0.8;
        }
        
        .guide-zone {
            fill: none;
            stroke: var(--cyan);
            stroke-width: 2;
            stroke-dasharray: 10,5;
            filter: drop-shadow(0 0 10px var(--cyan-glow));
            animation: pulse 3s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        .guide-line {
            stroke: var(--cyan);
            stroke-width: 1;
            stroke-dasharray: 5,5;
            opacity: 0.7;
        }
        
        .guide-amber {
            stroke: var(--amber);
            stroke-width: 2;
            stroke-dasharray: 8,4;
            opacity: 0.6;
        }
        
        .guide-label {
            fill: var(--cyan);
            font-family: 'JetBrains Mono', monospace;
            font-size: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.8;
        }

        /* AI Loading */
        #ai-loading { 
            position: absolute; 
            inset: 0; 
            background: rgba(0,0,0,0.9); 
            z-index: 200; 
            display: none; 
            justify-content: center; 
            align-items: center;
            flex-direction: column;
        }
        
        .spinner {
            border: 4px solid rgba(0, 243, 255, 0.1);
            border-top: 4px solid var(--cyan);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 0.8s linear infinite;
            margin-bottom: 15px;
            box-shadow: 0 0 20px var(--cyan-glow);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .ai-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--cyan);
        }

        /* 2. CONTROLLI SCROLLABILI */
        .controls {
            height: calc(60vh - 80px);
            width: 100%;
            background: var(--panel);
            overflow-y: auto; 
            padding: 1.5rem 1rem 2rem;
            -webkit-overflow-scrolling: touch;
        }

        .card { 
            background: var(--surface); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            padding: 1rem; 
            margin-bottom: 1rem;
            animation: slideUp 0.4s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        h3 { 
            color: var(--cyan); 
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem; 
            text-transform: uppercase; 
            letter-spacing: 0.1em;
            margin: 0 0 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        h3::before {
            content: '';
            width: 4px;
            height: 12px;
            background: var(--cyan);
            border-radius: 2px;
        }

        .btn { 
            border: none; 
            border-radius: 8px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Outfit', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-main { 
            background: linear-gradient(135deg, var(--amber) 0%, #ff8800 100%);
            color: #000; 
            width: 100%; 
            padding: 1rem; 
            font-size: 0.95rem; 
            margin-bottom: 0.75rem;
            box-shadow: 0 4px 15px var(--amber-glow);
        }
        
        .btn-main:active {
            transform: translateY(2px);
        }
        
        .btn-main.cyan-variant {
            background: linear-gradient(135deg, var(--cyan) 0%, #00a8ff 100%);
            box-shadow: 0 4px 15px var(--cyan-glow);
        }
        
        .btn-main.white-variant {
            background: linear-gradient(135deg, #fff 0%, #e0e0e0 100%);
        }
        
        .btn-tool { 
            background: transparent; 
            color: var(--cyan); 
            border: 1px solid var(--cyan); 
            padding: 0.75rem; 
            font-size: 0.75rem; 
            flex: 1;
        }
        
        .btn-tool:hover {
            background: rgba(0, 243, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .btn-tool.active { 
            background: var(--cyan); 
            color: #000;
            box-shadow: 0 0 20px var(--cyan-glow);
        }
        
        .row { 
            display: flex; 
            gap: 0.75rem; 
            margin-bottom: 0.75rem; 
        }

        label { 
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem; 
            color: #7d8590; 
            margin-bottom: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .slider-value {
            color: var(--cyan);
            font-weight: 600;
        }
        
        input[type="range"] { 
            width: 100%; 
            height: 6px;
            border-radius: 3px;
            background: var(--bg);
            outline: none;
            -webkit-appearance: none;
            margin-bottom: 1rem;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--cyan);
            cursor: pointer;
            box-shadow: 0 0 10px var(--cyan-glow);
            transition: all 0.2s;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 0 20px var(--cyan-glow);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--cyan);
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px var(--cyan-glow);
        }
        
        select, input[type="number"] { 
            width: 100%; 
            padding: 0.875rem; 
            background: var(--bg); 
            color: #e6edf3; 
            border: 1px solid var(--border); 
            border-radius: 8px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.875rem;
            cursor: pointer;
            outline: none;
        }
        
        select:focus, input[type="number"]:focus {
            border-color: var(--cyan);
            box-shadow: 0 0 0 2px var(--cyan-glow);
        }
        
        .hint {
            font-size: 0.65rem;
            color: #7d8590;
            margin-top: 0.25rem;
            font-family: 'JetBrains Mono', monospace;
        }

        /* STATUS BAR */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--panel);
            padding: 0.5rem 1rem;
            border-top: 1px solid var(--border);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: #7d8590;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--cyan);
            animation: blink 2s ease-in-out infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* 3. MODALE PREVIEW A4 */
        #a4-modal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: #1a1a1a; 
            z-index: 2000; 
            flex-direction: column;
        }

        .a4-header { 
            padding: 1rem; 
            background: var(--bg); 
            border-bottom: 1px solid var(--border); 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
        }
        
        .a4-scroll-area { 
            flex-grow: 1; 
            overflow: auto; 
            padding: 20px; 
            display: flex; 
            justify-content: center; 
            background: #2a2a2a;
        }
        
        /* Foglio A4 Virtuale */
        .a4-sheet { 
            width: 210mm; 
            min-height: 297mm;
            background: white; 
            padding: 20mm; 
            display: grid; 
            grid-template-columns: repeat(auto-fit, 35mm); 
            grid-auto-rows: 45mm; 
            gap: 5mm; 
            justify-content: start;
            align-content: start; 
            box-shadow: 0 4px 50px rgba(0,0,0,0.5);
        }
        
        .a4-photo { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            border: 0.1mm solid #ddd;
        }
        
        @media print {
            .no-print { display: none !important; }
            #a4-modal { position: absolute; display: block; }
            body { background: white; }
            .a4-sheet { box-shadow: none; page-break-after: always; }
        }
        
        @media (min-width: 768px) {
            .canvas-frame {
                width: 350px;
                height: 450px;
            }
        }
    </style>
</head>
<body>

<!-- HEADER -->
<header class="app-header no-print">
    <div class="app-title">‚¨¢ ICAO Biometric ID Generator</div>
    <div class="app-subtitle">Professional Edition ‚Ä¢ AI-Powered ‚Ä¢ ISO/IEC 19794-5</div>
</header>

<!-- 1. VIEWPORT -->
<div class="viewport no-print">
    <div id="ai-loading">
        <div class="spinner"></div>
        <div class="ai-text">AI Processing...</div>
    </div>
    
    <div class="canvas-frame">
        <video id="v" autoplay playsinline></video>
        <canvas id="editor-cvs"></canvas>
        
        <!-- Guide Biometriche ICAO Corrette -->
        <svg class="icao-mask" viewBox="0 0 280 360">
            <!-- Ovale viso: 70-80% dell'altezza (252px su 360px) -->
            <ellipse cx="140" cy="151" rx="82.5" ry="126" class="guide-zone" />
            
            <!-- Linea occhi: al 56% dall'alto -->
            <line x1="30" y1="130" x2="250" y2="130" class="guide-line" />
            <circle cx="90" cy="130" r="3" fill="var(--cyan)" opacity="0.8"/>
            <circle cx="190" cy="130" r="3" fill="var(--cyan)" opacity="0.8"/>
            
            <!-- Guida collo -->
            <line x1="105" y1="277" x2="105" y2="312" class="guide-line"/>
            <line x1="175" y1="277" x2="175" y2="312" class="guide-line"/>
            
            <!-- Guida spalle -->
            <path d="M 40,330 Q 140,345 240,330" class="guide-amber" fill="none"/>
            
            <!-- Labels -->
            <text x="140" y="115" text-anchor="middle" class="guide-label">Eyes Line</text>
            <text x="140" y="295" text-anchor="middle" class="guide-label">Neck</text>
            <text x="140" y="350" text-anchor="middle" class="guide-label">Shoulders</text>
        </svg>
    </div>
</div>

<!-- 2. CONTROLLI -->
<div class="controls no-print">
    <div id="ui-init">
        <button class="btn btn-main" id="btn-snap">üì∑ SCATTA FOTO</button>
        <div class="row">
            <button class="btn btn-tool" onclick="document.getElementById('file').click()">üìÅ Carica File</button>
            <button class="btn btn-tool" id="btn-flip">üîÑ Flip Camera</button>
        </div>
        <input type="file" id="file" hidden accept="image/*">
    </div>

    <div id="ui-edit" style="display:none">
        <div class="card">
            <h3>AI Processing</h3>
            <button class="btn btn-main white-variant" id="btn-ai">
                ‚ú® AI BACKGROUND REMOVAL
            </button>
            <div class="row">
                <button class="btn btn-tool" id="btn-beauty">üíé Beauty Mode</button>
                <button class="btn btn-tool" id="btn-reset">‚Üª Reset Posizione</button>
            </div>
            <div class="hint">
                Touch: Drag (1 dito) ‚Ä¢ Pinch (2 dita) | Mouse: Drag ‚Ä¢ Scroll
            </div>
        </div>

        <div class="card">
            <h3>Correzioni Immagine</h3>
            
            <label>
                <span>Zoom</span>
                <span class="slider-value" id="zoom-val">1.00x</span>
            </label>
            <input type="range" id="zoom-slider" min="0.5" max="3" step="0.01" value="1">
            
            <label>
                <span>Luminosit√†</span>
                <span class="slider-value" id="br-val">100%</span>
            </label>
            <input type="range" id="br" min="50" max="150" value="100">
            
            <label>
                <span>Contrasto</span>
                <span class="slider-value" id="ct-val">100%</span>
            </label>
            <input type="range" id="ct" min="50" max="150" value="100">
        </div>

        <div class="card">
            <h3>Output Settings</h3>
            
            <label style="display: block; margin-bottom: 0.5rem;">Formato Documento</label>
            <select id="doc-size" style="margin-bottom: 1rem;">
                <option value="35,45">üõÇ Passaporto / CIE (35√ó45mm)</option>
                <option value="30,40">üöó Patente (30√ó40mm)</option>
                <option value="50,50">üá∫üá∏ Visto USA (50√ó50mm)</option>
            </select>
            
            <label>
                <span>Copie per foglio A4</span>
                <span class="slider-value" id="copies-preview">4</span>
            </label>
            <input type="range" id="copies-slider" min="1" max="20" value="4">
            <div class="hint">Layout automatico ottimizzato</div>
        </div>

        <button class="btn btn-main cyan-variant" id="btn-pre-a4">
            üìÑ ANTEPRIMA A4 & EXPORT
        </button>
        
        <button class="btn btn-tool" onclick="location.reload()" style="width: 100%; color: #ff5555; border-color: #ff5555;">
            ‚úï Annulla e Ricomincia
        </button>
    </div>
</div>

<!-- STATUS BAR -->
<div class="status-bar no-print">
    <div class="status-indicator">
        <div class="status-dot"></div>
        <span id="status-text">System Ready</span>
    </div>
    <span>v3.0 Professional</span>
</div>

<!-- 3. MODALE A4 -->
<div id="a4-modal">
    <div class="a4-header no-print">
        <div>
            <label style="display: block;">Numero Copie</label>
            <input type="number" id="num-copies" value="4" min="1" max="40">
        </div>
        <button class="btn btn-main" onclick="window.print()">üñ®Ô∏è STAMPA PDF</button>
        <button class="btn btn-tool" id="btn-save-jpg">üíæ Salva JPG</button>
        <button class="btn btn-tool" id="btn-save-pdf">üìÑ Salva PDF</button>
        <button class="btn btn-tool" onclick="document.getElementById('a4-modal').style.display='none'">‚Üê Indietro</button>
    </div>
    <div class="a4-scroll-area">
        <div class="a4-sheet" id="a4-grid"></div>
    </div>
</div>

<script>
    // === ELEMENTI DOM ===
    const v = document.getElementById('v');
    const cvs = document.getElementById('editor-cvs');
    const ctx = cvs.getContext('2d', { willReadFrequently: true });
    const statusText = document.getElementById('status-text');
    
    // === STATE ===
    let rawImg = new Image();
    let aiMask = null;
    let px = 0, py = 0, sc = 1.0;
    let isDrag = false, lastX, lastY, lastDist = 0;
    let beauty = false, aiOn = false, side = "user";

    // === AI SEGMENTATION ===
    const selfie = new SelfieSegmentation({
        locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}`
    });
    selfie.setOptions({ modelSelection: 1 });
    selfie.onResults(res => { 
        aiMask = res.segmentationMask; 
        aiOn = true; 
        document.getElementById('ai-loading').style.display = 'none';
        document.getElementById('btn-ai').classList.add('active');
        draw();
        updateStatus('AI Background rimosso con successo');
    });

    // === CAMERA ===
    async function init() {
        try {
            if (v.srcObject) {
                v.srcObject.getTracks().forEach(track => track.stop());
            }
            
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: side, 
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                } 
            });
            v.srcObject = stream;
            updateStatus('Camera attiva');
        } catch (e) {
            alert('Errore camera: ' + e.message);
            updateStatus('Errore camera');
        }
    }
    
    init();
    
    document.getElementById('btn-flip').onclick = () => { 
        side = (side === "user" ? "environment" : "user"); 
        init(); 
    };

    // === EDITOR ===
    function startEdit(src) {
        document.getElementById('ui-init').style.display = 'none';
        document.getElementById('ui-edit').style.display = 'block';
        v.style.display = 'none';
        cvs.style.display = 'block';
        
        rawImg = new Image();
        rawImg.onload = () => {
            // Risoluzione alta per qualit√†
            cvs.width = 800;
            cvs.height = 1028;
            
            sc = Math.max(cvs.width / rawImg.width, cvs.height / rawImg.height);
            px = (cvs.width - rawImg.width * sc) / 2;
            py = (cvs.height - rawImg.height * sc) / 2;
            
            document.getElementById('zoom-slider').value = sc;
            document.getElementById('zoom-val').textContent = sc.toFixed(2) + 'x';
            
            draw();
            updateStatus('Foto caricata - Posiziona il soggetto');
        };
        rawImg.src = src;
    }

    document.getElementById('btn-snap').onclick = () => {
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = v.videoWidth;
        tempCanvas.height = v.videoHeight;
        const tempCtx = tempCanvas.getContext('2d');
        
        if (side === "user") {
            tempCtx.translate(tempCanvas.width, 0);
            tempCtx.scale(-1, 1);
        }
        
        tempCtx.drawImage(v, 0, 0);
        startEdit(tempCanvas.toDataURL('image/jpeg', 0.95));
    };
    
    document.getElementById('file').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (f) => startEdit(f.target.result);
        reader.readAsDataURL(e.target.files[0]);
    };

    // === RENDERING ENGINE ===
    function draw() {
        ctx.save();
        ctx.clearRect(0, 0, cvs.width, cvs.height);
        
        const brightness = document.getElementById('br').value;
        const contrast = document.getElementById('ct').value;

        // Se AI attiva, usa compositing corretto
        if (aiOn && aiMask) {
            // 1. Disegna sfondo neutro ICAO
            ctx.fillStyle = "#F5F5F5";
            ctx.fillRect(0, 0, cvs.width, cvs.height);
            
            // 2. Crea canvas temporaneo per l'immagine processata
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = rawImg.width;
            tempCanvas.height = rawImg.height;
            const tempCtx = tempCanvas.getContext('2d');
            
            // 3. Disegna l'immagine originale
            let filterString = `brightness(${brightness}%) contrast(${contrast}%)`;
            if (beauty) {
                filterString += ` saturate(115%) blur(0.4px)`;
            }
            tempCtx.filter = filterString;
            tempCtx.drawImage(rawImg, 0, 0);
            
            // 4. Applica la maschera AI (destination-in = mostra solo dove c'√® la persona)
            tempCtx.globalCompositeOperation = "destination-in";
            tempCtx.drawImage(aiMask, 0, 0);
            
            // 5. Disegna il risultato finale con zoom e posizione
            ctx.drawImage(tempCanvas, px, py, rawImg.width * sc, rawImg.height * sc);
            
            // 6. Beauty glow effect se attivo
            if (beauty) {
                ctx.globalAlpha = 0.3;
                ctx.filter = `brightness(${brightness}%) blur(3px) contrast(110%)`;
                ctx.drawImage(tempCanvas, px, py, rawImg.width * sc, rawImg.height * sc);
                ctx.globalAlpha = 1.0;
            }
        } else {
            // Modalit√† normale senza AI
            let filterString = `brightness(${brightness}%) contrast(${contrast}%)`;
            
            if (beauty) {
                filterString += ` saturate(115%) blur(0.4px)`;
                ctx.filter = filterString;
                ctx.drawImage(rawImg, px, py, rawImg.width * sc, rawImg.height * sc);
                
                // Beauty glow effect
                ctx.globalAlpha = 0.4;
                ctx.filter = `brightness(${brightness}%) blur(3px) contrast(110%)`;
                ctx.drawImage(cvs, 0, 0);
                ctx.globalAlpha = 1.0;
            } else {
                ctx.filter = filterString;
                ctx.drawImage(rawImg, px, py, rawImg.width * sc, rawImg.height * sc);
            }
        }
        
        ctx.restore();
    }

    // === TOUCH GESTURES ===
    const getPos = (e) => ({
        x: e.touches ? e.touches[0].clientX : e.clientX,
        y: e.touches ? e.touches[0].clientY : e.clientY
    });
    
    cvs.ontouchstart = cvs.onmousedown = (e) => {
        if (e.touches && e.touches.length === 2) {
            lastDist = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
        } else {
            isDrag = true;
            const p = getPos(e);
            lastX = p.x;
            lastY = p.y;
        }
    };
    
    window.ontouchmove = window.onmousemove = (e) => {
        if (e.touches && e.touches.length === 2) {
            e.preventDefault();
            const currentDist = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
            sc *= (currentDist / lastDist);
            sc = Math.max(0.5, Math.min(3, sc));
            lastDist = currentDist;
            document.getElementById('zoom-slider').value = sc;
            document.getElementById('zoom-val').textContent = sc.toFixed(2) + 'x';
        } else if (isDrag) {
            const p = getPos(e);
            px += (p.x - lastX) * (cvs.width / cvs.offsetWidth);
            py += (p.y - lastY) * (cvs.height / cvs.offsetHeight);
            lastX = p.x;
            lastY = p.y;
        }
        draw();
    };
    
    window.ontouchend = window.onmouseup = () => {
        isDrag = false;
        lastDist = 0;
    };
    
    cvs.onwheel = (e) => {
        e.preventDefault();
        sc *= (e.deltaY < 0 ? 1.1 : 0.9);
        sc = Math.max(0.5, Math.min(3, sc));
        document.getElementById('zoom-slider').value = sc;
        document.getElementById('zoom-val').textContent = sc.toFixed(2) + 'x';
        draw();
    };

    // === AZIONI AI & BEAUTY ===
    document.getElementById('btn-ai').onclick = () => {
        if (aiOn) {
            // Disattiva AI
            aiOn = false;
            aiMask = null;
            document.getElementById('btn-ai').classList.remove('active');
            draw();
            updateStatus('AI Background disattivato');
            return;
        }
        
        // Attiva AI
        document.getElementById('ai-loading').style.display = 'flex';
        updateStatus('Elaborazione AI in corso...');
        
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = rawImg.width;
        tempCanvas.height = rawImg.height;
        tempCanvas.getContext('2d').drawImage(rawImg, 0, 0);
        
        selfie.send({ image: tempCanvas });
    };
    
    document.getElementById('btn-beauty').onclick = function() {
        beauty = !beauty;
        this.classList.toggle('active');
        draw();
        updateStatus('Beauty Mode ' + (beauty ? 'ON' : 'OFF'));
    };
    
    document.getElementById('btn-reset').onclick = () => {
        sc = Math.max(cvs.width / rawImg.width, cvs.height / rawImg.height);
        px = (cvs.width - rawImg.width * sc) / 2;
        py = (cvs.height - rawImg.height * sc) / 2;
        document.getElementById('zoom-slider').value = sc;
        document.getElementById('zoom-val').textContent = sc.toFixed(2) + 'x';
        draw();
        updateStatus('Posizione resettata');
    };
    
    // Sliders
    document.getElementById('zoom-slider').oninput = (e) => {
        sc = parseFloat(e.target.value);
        document.getElementById('zoom-val').textContent = sc.toFixed(2) + 'x';
        draw();
    };
    
    document.getElementById('br').oninput = (e) => {
        document.getElementById('br-val').textContent = e.target.value + '%';
        draw();
    };
    
    document.getElementById('ct').oninput = (e) => {
        document.getElementById('ct-val').textContent = e.target.value + '%';
        draw();
    };
    
    document.getElementById('copies-slider').oninput = (e) => {
        document.getElementById('copies-preview').textContent = e.target.value;
    };

    // === A4 PREVIEW & EXPORT ===
    const modal = document.getElementById('a4-modal');
    const grid = document.getElementById('a4-grid');
    
    document.getElementById('btn-pre-a4').onclick = () => {
        const numCopies = parseInt(document.getElementById('copies-slider').value);
        document.getElementById('num-copies').value = numCopies;
        updateA4();
        modal.style.display = 'flex';
        updateStatus(`Preview A4 generata: ${numCopies} copie`);
    };

    function updateA4() {
        grid.innerHTML = '';
        const imgData = cvs.toDataURL('image/jpeg', 0.95);
        const [w, h] = document.getElementById('doc-size').value.split(',');
        const numCopies = parseInt(document.getElementById('num-copies').value);
        
        grid.style.gridTemplateColumns = `repeat(auto-fit, ${w}mm)`;
        grid.style.gridAutoRows = `${h}mm`;

        for (let i = 0; i < numCopies; i++) {
            const img = new Image();
            img.className = 'a4-photo';
            img.src = imgData;
            img.style.width = w + 'mm';
            img.style.height = h + 'mm';
            grid.appendChild(img);
        }
    }

    document.getElementById('num-copies').oninput = updateA4;

    document.getElementById('btn-save-jpg').onclick = () => {
        html2canvas(grid, { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
            const link = document.createElement('a');
            link.download = `foglio_fototessera_${Date.now()}.jpg`;
            link.href = canvas.toDataURL('image/jpeg', 0.95);
            link.click();
            updateStatus('JPG salvato');
        });
    };
    
    document.getElementById('btn-save-pdf').onclick = () => {
        const pdf = new jspdf.jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
        });
        
        const imgData = cvs.toDataURL('image/jpeg', 0.95);
        const [w, h] = document.getElementById('doc-size').value.split(',').map(Number);
        const numCopies = parseInt(document.getElementById('num-copies').value);
        
        const pageWidth = 210;
        const pageHeight = 297;
        const margin = 20;
        const spacing = 5;
        
        const maxCols = Math.floor((pageWidth - 2 * margin + spacing) / (w + spacing));
        const maxRows = Math.floor((pageHeight - 2 * margin + spacing) / (h + spacing));
        const maxPerPage = maxCols * maxRows;
        
        let currentPage = 0;
        let copiesOnPage = 0;
        
        for (let i = 0; i < numCopies; i++) {
            if (copiesOnPage >= maxPerPage) {
                pdf.addPage();
                currentPage++;
                copiesOnPage = 0;
            }
            
            const col = copiesOnPage % maxCols;
            const row = Math.floor(copiesOnPage / maxCols);
            
            const x = margin + col * (w + spacing);
            const y = margin + row * (h + spacing);
            
            pdf.addImage(imgData, 'JPEG', x, y, w, h);
            copiesOnPage++;
        }
        
        const totalPages = currentPage + 1;
        pdf.save(`documento_biometrico_${numCopies}_copie.pdf`);
        updateStatus(`PDF salvato: ${numCopies} copie su ${totalPages} pagine`);
    };

    // === UTILITY ===
    function updateStatus(text) {
        statusText.textContent = text;
    }
</script>
</body>
</html>